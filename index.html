<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éŠ€æ²³å¥¶ç‰›è¿·å®®æ”¶ç›Š</title>
    <style>
        :root { --gold: #ffd700; --bg: #0b0e14; --panel: #1a1f29; --border: #2d3748; --text: #e2e8f0; --green: #4fd1c5; --blue: #63b3ed; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1000px; background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--gold); text-align: center; margin-bottom: 25px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.85rem; }
        th { background: #2d3748; color: var(--gold); padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        
        /* è¡¨æ ¼å¯¬åº¦æ¯”ä¾‹ */
        .config-table th:nth-child(1), .config-table td:nth-child(1) { width: 15%; }
        .config-table th:nth-child(2), .config-table td:nth-child(2) { width: 15%; }
        .config-table th:nth-child(3), .config-table td:nth-child(3) { width: 20%; }
        .config-table th:nth-child(4), .config-table td:nth-child(4) { width: 20%; }

        select, input { background: #0b0e14; color: var(--green); border: 1px solid var(--gold); padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .token-qty { color: var(--green); font-weight: bold; text-align: center; }
        .other-val { color: var(--blue); font-weight: bold; text-align: right; }
        .btn-fetch { background: var(--gold); color: #1a202c; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; margin-bottom: 15px; transition: 0.2s; }
        .btn-fetch:hover { background: #e6c200; transform: translateY(-1px); }
        .status { text-align: center; font-size: 0.8rem; color: #718096; margin-bottom: 10px; min-height: 1.2em; }
        .rev-table td:first-child { text-align: left; }
        .rev-table th:nth-child(2), .rev-table td:nth-child(2) { text-align: center; }
        .rev-table th:nth-child(3), .rev-table td:nth-child(3) { text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h2>éŠ€æ²³å¥¶ç‰›è¿·å®®æ”¶ç›Š</h2>
    
    <div id="status-msg" class="status">æç¤ºï¼šæ•¸æ“šæ¯ 30 åˆ†é˜è‡ªå‹•åŒæ­¥ä¸€æ¬¡</div>
    <button class="btn-fetch" onclick="updatePrices()">ğŸ”„ å¾æœ¬åœ°å€‰åº«åŒæ­¥æœ€æ–°å–®åƒ¹</button>

    <div class="grid-layout">
        <div>
            <table class="config-table">
                <thead>
                    <tr><th>é …ç›®</th><th>ç­‰ç´š</th><th>æ•¸é‡</th><th>å–®åƒ¹</th></tr>
                </thead>
                <tbody id="config-body"></tbody>
                <tr style="background: rgba(99, 179, 237, 0.05);">
                    <td colspan="2">ç²¾ç…‰ç¢ç‰‡</td>
                    <td colspan="2"><input type="number" id="refining-shard-price" value="2500000" oninput="calculate()"></td>
                </tr>
                <tr style="background: rgba(99, 179, 237, 0.05);">
                    <td colspan="2">ç´«å¤šæ‹‰ä¹‹ç›’(ç”Ÿæ´»)</td>
                    <td colspan="2"><input type="number" id="box-price" value="900000" oninput="calculate()"></td>
                </tr>
                <tr style="background: rgba(99, 179, 237, 0.05);">
                    <td colspan="2">ç´«å¤šæ‹‰ä¹‹ç›’(æˆ°é¬¥)</td>
                    <td colspan="2"><input type="number" id="box-price" value="900000" oninput="calculate()"></td>
                </tr>
            </table>
            <div id="total-cost-display" style="text-align: right; font-weight: bold; color: var(--gold); font-size: 1.1rem;">
                ç¸½é ä¼°æˆæœ¬ï¼š0
            </div>
        </div>

        <div>
            <table class="rev-table">
                <thead>
                    <tr>
                        <th>æ¨“å±¤é€²åº¦</th>
                        <th>ä»£å¹£æ•¸é‡</th>
                        <th>å…¶ä»–æ”¶ç›Š (ä¸å«ä»£å¹£)</th>
                    </tr>
                </thead>
                <tbody id="revenue-body"></tbody>
            </table>
            <div style="font-size: 0.75rem; color: #718096; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                * <b>ä»£å¹£ç´¯è¨ˆ</b>ï¼šåŒ…å«å‡ºå£å›ºå®šçå‹µåŠæˆ¿é–“æœŸæœ›ç”¢å‡ºã€‚<br>
                * <b>å…¶ä»–æ”¶ç›Š</b>ï¼šåƒ…è¨ˆç®—ç´«å¤šæ‹‰ä¹‹ç›’èˆ‡ç¬¬ 6 å±¤èµ·çš„ç²¾ç…‰ç¢ç‰‡ã€‚
            </div>
        </div>
    </div>
</div>

<script>
// ä¿®æ­£é“å…·æ¸…å–®ï¼šå°é½Šå®˜æ–¹ data.json çš„ hrid_base
const items = [
    { key: 'torch', name: 'ç«æŠŠ', qty: 100, level: 'expert', hrid_base: 'torch' },
    { key: 'curtain', name: 'æ–—ç¯·', qty: 4, level: 'expert', hrid_base: 'shroud' }, // è¿·å®®æ–—ç¯·æ˜¯ shroud
    { key: 'beacon', name: 'ä¿¡æ¨™', qty: 5, level: 'expert', hrid_base: 'beacon' },
    { key: 'tea', name: 'èŒ¶è‘‰ç®±', qty: 1, level: 'expert', hrid_base: 'tea_crate' },
    { key: 'coffee', name: 'å’–å•¡ç®±', qty: 1, level: 'expert', hrid_base: 'coffee_crate' },
    { key: 'food', name: 'é£Ÿç‰©ç®±', qty: 1, level: 'expert', hrid_base: 'food_crate' }
];

function init() {
    const body = document.getElementById('config-body');
    body.innerHTML = items.map((item, i) => `
        <tr>
            <td>${item.name}</td>
            <td>
                <select id="lvl-${i}" onchange="calculate()">
                    <option value="basic">åŸºç¤</option>
                    <option value="advanced">é€²éš</option>
                    <option value="expert" selected>å°ˆå®¶</option>
                </select>
            </td>
            <td><input type="number" id="qty-${i}" value="${item.qty}" oninput="calculate()"></td>
            <td><input type="number" id="prc-${i}" value="0" oninput="calculate()"></td>
        </tr>
    `).join('');
    calculate();
}

async function updatePrices() {
    const status = document.getElementById('status-msg');
    status.innerText = "â³ æ­£åœ¨åŒæ­¥æ•¸æ“š...";

    try {
        // ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼Œé¿å… GitHub Pages å­è·¯å¾‘å•é¡Œ
        const res = await fetch('./data.json?t=' + Date.now());
        if (!res.ok) throw new Error("è®€å– data.json å¤±æ•—");

        const data = await res.json();
        // æ‚¨çš„è³‡æ–™æ ¼å¼æ˜¯åœ¨ marketData ç‰©ä»¶ä¸‹
        const market = data.marketData;

        if (!market) throw new Error("æ•¸æ“šçµæ§‹ä¸åŒ¹é… (æ‰¾ä¸åˆ° marketData)");

        // 1. åŒæ­¥ç²¾ç…‰ç¢ç‰‡ (labyrinth_refinement_shard)
        const shardHrid = "/items/labyrinth_refinement_shard";
        if (market[shardHrid] && market[shardHrid]["0"]) {
            document.getElementById('refining-shard-price').value = market[shardHrid]["0"].a;
        }

        // 2. åŒæ­¥å…¶ä»–æ¶ˆè€—å“
        items.forEach((item, i) => {
            const lvl = document.getElementById(`lvl-${i}`).value;
            const hrid = `/items/${lvl}_${item.hrid_base}`;
            
            // ç‰©ä»¶è®€å–æ–¹å¼ï¼šmarket["/items/expert_torch"]["0"].a
            if (market[hrid] && market[hrid]["0"]) {
                document.getElementById(`prc-${i}`).value = market[hrid]["0"].a;
            }
        });

        status.innerText = "âœ… åŒæ­¥æˆåŠŸï¼(" + new Date().toLocaleTimeString() + ")";
        status.style.color = "#4fd1c5";
        calculate();
    } catch (e) {
        status.innerText = "âŒ å¤±æ•—ï¼š" + e.message;
        status.style.color = "#ff4d4d";
    }
}

function calculate() {
    let totalCost = 0;
    items.forEach((_, i) => {
        const q = parseFloat(document.getElementById(`qty-${i}`).value) || 0;
        const p = parseFloat(document.getElementById(`prc-${i}`).value) || 0;
        totalCost += q * p;
    });
    document.getElementById('total-cost-display').innerText = `ç¸½é ä¼°æˆæœ¬ï¼š${Math.round(totalCost).toLocaleString()}`;

    const revBody = document.getElementById('revenue-body');
    revBody.innerHTML = '';
    const boxVal = parseFloat(document.getElementById('box-price').value) || 0;
    const shardVal = parseFloat(document.getElementById('refining-shard-price').value) || 0;

    let accTokens = 0, accOther = 0;
    for (let l = 1; l <= 10; l++) {
        accTokens += (5 * l) + (l * 0.5);
        let layerOther = (l * 0.12) * boxVal;
        if (l >= 6) {
            // åŒ…å« 5% å¤§çæ©Ÿç‡çš„ç²¾ç…‰ç¢ç‰‡æœŸæœ›å€¼ï¼š1.8
            layerOther += ((l - 4) / 2) * 1.8 * shardVal;
        }
        accOther += layerOther;
        revBody.innerHTML += `<tr><td>åˆ°ç¬¬ ${l} å±¤ç´¯è¨ˆ</td><td class="token-qty">${Math.round(accTokens)}</td><td class="other-val">${Math.round(accOther).toLocaleString()}</td></tr>`;
    }
}
window.onload = init;
</script>
</body>
</html>
