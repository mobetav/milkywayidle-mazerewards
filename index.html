<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éŠ€æ²³å¥¶ç‰›ï¼šè¿·å®®æ”¶ç›Šè¨ˆç®— (Actions è‡ªå‹•åŒ–ç‰ˆ)</title>
    <style>
        :root { --gold: #ffd700; --bg: #0b0e14; --panel: #1a1f29; --border: #2d3748; --text: #e2e8f0; --green: #4fd1c5; --blue: #63b3ed; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1000px; background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--gold); text-align: center; margin-bottom: 25px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.85rem; }
        th { background: #2d3748; color: var(--gold); padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        
        /* ä¿æŒ 15/15/20/20 æ¯”ä¾‹ */
        .config-table th:nth-child(1), .config-table td:nth-child(1) { width: 15%; }
        .config-table th:nth-child(2), .config-table td:nth-child(2) { width: 15%; }
        .config-table th:nth-child(3), .config-table td:nth-child(3) { width: 20%; }
        .config-table th:nth-child(4), .config-table td:nth-child(4) { width: 20%; }

        select, input { background: #0b0e14; color: var(--green); border: 1px solid var(--gold); padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .token-qty { color: var(--green); font-weight: bold; text-align: center; }
        .other-val { color: var(--blue); font-weight: bold; text-align: right; }
        .btn-sync { background: var(--gold); color: #1a202c; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; margin-bottom: 15px; }
        .status { text-align: center; font-size: 0.8rem; color: #718096; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸŒŒ éŠ€æ²³å¥¶ç‰›ï¼šè¿·å®®æ”¶ç›Šåˆ†æ</h2>
    
    <div id="status-msg" class="status">æç¤ºï¼šæ•¸æ“šæ¯ 30 åˆ†é˜è‡ªå‹•åŒæ­¥ä¸€æ¬¡</div>
    <button class="btn-sync" onclick="updatePrices()">ğŸ”„ å¾æœ¬åœ°å€‰åº«åŒæ­¥æœ€æ–°å–®åƒ¹</button>

    <div class="grid-layout">
        <div>
            <table class="config-table">
                <thead>
                    <tr><th>é …ç›®</th><th>ç­‰ç´š</th><th>æ•¸é‡</th><th>å–®åƒ¹</th></tr>
                </thead>
                <tbody id="config-body"></tbody>
                <tr style="background: rgba(99, 179, 237, 0.05);">
                    <td colspan="2" style="color: var(--blue);">ç²¾ç…‰ç¢ç‰‡ä¼°åƒ¹</td>
                    <td colspan="2"><input type="number" id="refining-shard-price" value="2500000" oninput="calculate()"></td>
                </tr>
                <tr style="background: rgba(255, 215, 0, 0.05);">
                    <td colspan="2" style="color: var(--gold);">ç´«å¤šæ‹‰ä¹‹ç›’ä¼°åƒ¹</td>
                    <td colspan="2"><input type="number" id="box-price" value="900000" oninput="calculate()"></td>
                </tr>
            </table>
            <div id="total-cost-display" style="text-align: right; font-weight: bold; color: var(--gold); font-size: 1.1rem;">ç¸½é ä¼°æˆæœ¬ï¼š0</div>
        </div>

        <div>
            <table class="rev-table">
                <thead>
                    <tr><th>æ¨“å±¤é€²åº¦</th><th>ä»£å¹£ç´¯è¨ˆ</th><th>å…¶ä»–æ”¶ç›Š (ä¸å«ä»£å¹£)</th></tr>
                </thead>
                <tbody id="revenue-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const items = [
        { key: 'torch', name: 'ç«æŠŠ', qty: 100, level: 'expert', hrid_base: 'torch' },
        { key: 'curtain', name: 'æ–—ç¯·', qty: 4, level: 'expert', hrid_base: 'curtain' },
        { key: 'beacon', name: 'ä¿¡æ¨™', qty: 5, level: 'expert', hrid_base: 'beacon' },
        { key: 'tea', name: 'èŒ¶è‘‰ç®±', qty: 1, level: 'expert', hrid_base: 'tea_box' },
        { key: 'coffee', name: 'å’–å•¡ç®±', qty: 1, level: 'expert', hrid_base: 'coffee_box' },
        { key: 'food', name: 'é£Ÿç‰©ç®±', qty: 1, level: 'expert', hrid_base: 'food_box' }
    ];

    function init() {
        const body = document.getElementById('config-body');
        body.innerHTML = items.map((item, i) => `
            <tr>
                <td>${item.name}</td>
                <td><select id="lvl-${i}" onchange="calculate()"><option value="expert" selected>å°ˆå®¶</option><option value="advanced">é€²éš</option><option value="basic">åŸºç¤</option></select></td>
                <td><input type="number" id="qty-${i}" value="${item.qty}" oninput="calculate()"></td>
                <td><input type="number" id="prc-${i}" value="0" oninput="calculate()"></td>
            </tr>
        `).join('');
        calculate();
    }

    async function updatePrices() {
        const status = document.getElementById('status-msg');
        status.innerText = "â³ æ­£åœ¨è®€å–æœ¬åœ°è‡ªå‹•åŒ–æ•¸æ“š (data.json)...";
        try {
            // è®€å– Actions ç”Ÿæˆçš„ data.json ä¸¦å¼·åˆ¶åˆ·æ–°å¿«å–
            const res = await fetch('./data.json?t=' + Date.now());
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ°æ•¸æ“šæª”æ¡ˆ");

            const data = await res.json();
            const market = data.marketplace;

            items.forEach((item, i) => {
                const lvl = document.getElementById(`lvl-${i}`).value;
                const hrid = `/items/${lvl}_${item.hrid_base}`;
                const found = market.find(m => m.itemHrid === hrid);
                if (found) {
                    document.getElementById(`prc-${i}`).value = found.ask;
                }
            });

            status.innerText = "âœ… åŒæ­¥æˆåŠŸï¼ (" + new Date().toLocaleTimeString() + ")";
            status.style.color = "#4fd1c5";
            calculate();
        } catch (e) {
            status.innerText = "âŒ å¤±æ•—ï¼š" + e.message;
            status.style.color = "#ff4d4d";
        }
    }

    function calculate() {
        let totalCost = 0;
        items.forEach((_, i) => {
            totalCost += (parseFloat(document.getElementById(`qty-${i}`).value) || 0) * (parseFloat(document.getElementById(`prc-${i}`).value) || 0);
        });
        document.getElementById('total-cost-display').innerText = `ç¸½é ä¼°æˆæœ¬ï¼š${Math.round(totalCost).toLocaleString()} Coins`;

        const revBody = document.getElementById('revenue-body');
        revBody.innerHTML = '';
        const boxVal = parseFloat(document.getElementById('box-price').value) || 0;
        const shardPrice = parseFloat(document.getElementById('refining-shard-price').value) || 0;
        
        let accTokens = 0, accOther = 0;
        for (let l = 1; l <= 10; l++) {
            accTokens += (5 * l) + (l * 0.5);
            let layerOther = (l * 0.12) * boxVal;
            if (l >= 6) {
                // æ ¹æ“šæ‚¨çš„æ©Ÿç‡åœ–è¨ˆç®—å‡ºçš„æœŸæœ›å€¼ 1.8 (å« 5% å¤§ç)
                layerOther += ((l - 4) / 2) * 1.8 * shardPrice;
            }
            accOther += layerOther;
            revBody.innerHTML += `<tr><td>åˆ°ç¬¬ ${l} å±¤ç´¯è¨ˆ</td><td class="token-qty">${Math.round(accTokens)}</td><td class="other-val">${Math.round(accOther).toLocaleString()}</td></tr>`;
        }
    }
    window.onload = init;
</script>
</body>
</html>
